BootStrap: docker
From: scilus/singularity-base-tractoflow:latest

%environment
	export MATPLOTLIBRC="/usr/local/lib/python3.5/dist-packages/matplotlib/mpl-data/"

%setup
	export HUMAN_DATA=human-data_master_1d3abfb.tar.bz2

	mkdir $SINGULARITY_ROOTFS/human-data
	tar -jxf $HUMAN_DATA -C $SINGULARITY_ROOTFS/human-data

%post
	export LC_CTYPE="en_US.utf8"
	export LC_ALL="en_US.utf8"
	export LANG="en_US.utf8"
	export LANGUAGE="en_US.utf8"
	apt-get -y install python3-pip
	apt-get -y install python3-dev
	apt-get -y install unzip
	apt-get -y install python3
	apt-get -y install python3-tk

	cd /
	wget https://github.com/GuillaumeTh/scilpy/archive/e8df2b7.zip
	unzip e8df2b7.zip
	mv scilpy-e8df2b7 scilpy
	cd /scilpy
	pip3 install -r requirements.txt
	pip3 install -r requirements-git.txt
	pip3 install setuptools==40.2.0
	python3 setup.py install
	python3 setup.py install_scripts

	# Doing them here since Amico depends on Dipy.
	pip3 install --index-url https://test.pypi.org/simple/ spams==2.6.1.11
	pip3 install https://github.com/jchoude/AMICO/archive/NF_better_fw_correction.zip

	sed -i '41s/.*/backend : Agg/' /usr/local/lib/python3.5/dist-packages/matplotlib/mpl-data/matplotlibrc

