BootStrap: docker
From: ubuntu:xenial

%environment
	export PATH=/mrtrix3/bin:$PATH
	FSLDIR=/usr/share/fsl/5.0
	. ${FSLDIR}/etc/fslconf/fsl.sh
	PATH=${FSLDIR}/bin:${PATH}
	export FSLDIR PATH
	export PYTHONPATH=/scilpy:$PYTHONPATH
	export PATH=/scilpy/scripts:$PATH
	export PATH=/scilpy/surgery_scripts:$PATH
	export PATH=/scilpy/dev_scripts:$PATH
	export ITK_GLOBAL_DEFAULT_NUMBER_OF_THREADS=8
	export OPENBLAS_NUM_THREADS=1
	export ANTSPATH=/usr/lib/ants
	export PATH=$PATH:$ANTSPATH
	export MATPLOTLIBRC="/usr/local/lib/python2.7/dist-packages/matplotlib/mpl-data/"
	export LC_ALL=C

%setup
	export SCILPY=scilpy_master_007b604.tar.bz2

	mkdir $SINGULARITY_ROOTFS/scilpy
	tar -jxf $SCILPY -C $SINGULARITY_ROOTFS/scilpy

%post
	sed -i 's/main/main restricted universe/g' /etc/apt/sources.list
	apt-get update && apt-get -y upgrade
	apt-get -y  install wget
	wget -O- http://neuro.debian.net/lists/xenial.us-ca.full | tee /etc/apt/sources.list.d/neurodebian.sources.list
	apt-key adv --recv-keys --keyserver pool.sks-keyservers.net 2649A5A9 || { wget -q -O- http://neuro.debian.net/_static/neuro.debian.net.asc | apt-key add -; }
	apt-get update
	apt-get -y install cmake
	apt-get -y install git
	apt-get -y install build-essential
	apt-get -y install zlib1g-dev
	apt-get -y install python-pip
	apt-get -y install python-dev
	apt-get -y install g++
	apt-get -y install gcc
	apt-get -y install python
	apt-get -y install libeigen3-dev
	apt-get -y install libqt4-opengl-dev
	apt-get -y install libgl1-mesa-dev
	apt-get -y install libfftw3-dev
	apt-get -y install libtiff5-dev
	apt-get -y install clang
	apt-get -y install fsl-5.0=5.0.9-4~nd16.04+1
	apt-get -y install fsl-5.0-eddy-nonfree=5.0.9-1~nd16.04+1
	apt-get -y install libgsl0-dev
	apt-get -y install python-tk
	apt-get -y install ants=2.2.0-1~nd16.04+1
	pip install h5py==2.6.0
	pip install setuptools==38.5.1
	pip install http://github.com/MarcCote/tractconverter/archive/master.zip

	wget https://fsl.fmrib.ox.ac.uk/fsldownloads/patches/eddy-patch-fsl-5.0.9/centos6/eddy_openmp
	chmod +x eddy_openmp
	mv eddy_openmp /usr/share/fsl/5.0/bin/eddy_openmp

	cd /
	git clone https://github.com/MRtrix3/mrtrix3.git
	cd mrtrix3
	git fetch --tags
	git checkout tags/3.0_RC3 -b 3.0_RC3
	./configure
	./build

	cd /scilpy
	pip install -r requirements.txt
	python setup.py build_all

	sed -i '38s/.*/backend : Agg/' /usr/local/lib/python2.7/dist-packages/matplotlib/mpl-data/matplotlibrc

